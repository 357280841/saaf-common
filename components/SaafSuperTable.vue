/*
 * @Author: zhengxiaowen; 357280841@qq.com; 
 * @Date: 2019-07-17 16:28:12 
 * @Last Modified by: zhengxiaowen
 * @Last Modified time: 2019-11-20 14:50:52
 */

<template>
  <div ref="SaafSuperTableContent">
    <SaafListPageHeader ref="SaafListPageHeader" :title="tableConfig.pageHeader.title">
      <ButtonGroup size="small" class="mr10" v-if="!tableConfig.pageHeader.hideQueryBtn">
        <Button size="small" @click="getFirstPage()"><span class="fa fa-search pr5"></span>搜索</Button>
        <Button size="small" @click="$refs.SaafParamForm.resetFormValue()"><span class="fa fa-undo pr5"></span>重置</Button>
      </ButtonGroup>
      <div style="display: inline-block">
        <slot name="btnGroup"></slot>
      </div>
        <SaafResourceButton
        style="display: inline-block;" 
        :menuId="$route.query.menuId"
        :respId="$route.query.respId"
        :functionList="functionList">
          <template slot="btnGroup">
            <slot name="btnGroup"></slot>
          </template> 
        </SaafResourceButton>
    </SaafListPageHeader>
    <SaafParamForm ref="SaafParamForm" :items="tableConfig.searchItems">
      <template v-for="(item,key) in tableConfig.searchItems" v-slot:[key]="scope">
        <slot :name="key" v-if="item.type === 'slot'" v-bind="scope"></slot>
      </template>
    </SaafParamForm>
    <SaafTable
     ref="SaafTable"
     :height="tableHeight"
     :columns="tableConfig.tableColumns"
     :list="tableList" 
     :page.sync="tablePage"
     :getData="getData"
     :loading="loading"
     :currentRow.sync="currentRow" />
    <SaafDelModalV2 ref="SaafDelModalV2"></SaafDelModalV2>
  </div>
</template>

<script>
  
import {fetch,api} from '@/page/pageConfig/index'
import { Promise, resolve, reject } from 'q';
import { fetchTool, pageTool, tabsTool, gridButton, getUrl } from '../index'

export default {
    props:{
      tableConfig:{
        type: Object,
        required: true,
      }
    },
    data(){
      return {
        tableList: [],
        tablePage: pageTool.createrPage(),
        tabsTool: tabsTool,
        currentRow: null,
        tableHeight: null,
        functionList: {},
        loading:false
      }
    },
    created(){
    },
    mounted(){
      this.formatFunctionList()
    },
    methods:{
      refreshData(){
        this.getPage({
          ...this.tablePage,
          nextIndex: 1,
        })
      },
      getData(){
        this.getPage(this.tablePage)
      },
      getPage(page){
        this.currentRow=null;
        this.resetTableHeight()
        this.$refs.SaafTable.scrollTop()
        return new Promise((resolve, reject)=>{
          this.loading = true
          fetchTool.postSimpleness(api[this.tableConfig.findApi],{
            ...this.$refs.SaafParamForm.getParams(),
            ...this.tableConfig.searchParams,
            pageIndex: page.nextIndex,
            pageRows: page.pageSize
          }).then(res=>{
            this.loading = false
            this.tableList = res.data
            this.tablePage = pageTool.update(res,this.tablePage)
            resolve()
          }).catch(err=>{
            this.loading = false
            reject(err)
          })
        })
      },
      getFirstPage(){
        // console.log(this.$refs.SaafTable)
        // this.$refs.SaafTable.scrollTop = 0
        this.$refs.SaafTable.getFirstPage()
      },
      resetTableHeight(){
        // console.log($(window).innerHeight())
        // console.log(this.$store.state.system.screenHeight)
        // console.log($(this.$refs.SaafListPageHeader.$el).offset())
        setTimeout(()=>{
          this.tableHeight = this.$store.state.system.screenHeight-this.$refs.SaafListPageHeader.$el.clientHeight-this.$refs.SaafParamForm.$el.clientHeight-this.$refs.SaafTable.$refs.Page.$el.clientHeight-20-15
        })
      },
      formatFunctionList(){
        let val = this.tableConfig.pageHeader.functionList
        let functionList = {}
        for(let key in val){
          if((key == 'btnModify') && !val[key].disabled){
            functionList[key] = {
              fun: val[key],
              disabled: ()=>{ return this.currentRow ? false : true },
              ...val[key]
            }
          }else if((key == 'btnDel') && !val[key].disabled){
            let fun = null
            if(val[key] && val[key].fun){
              fun = val[key].fun
            }else{
              fun = val[key]
            }
            functionList[key] = {
              fun: ()=>{
                this.$refs.SaafDelModalV2.open(()=>{fun();this.currentRow=null;})
              },
              disabled: ()=>{ return this.currentRow ? false : true },
              ...val[key]
            }
          }else{
            functionList[key] = val[key]
          }
        }
        this.functionList = functionList
      },
    },
    watch:{
      currentRow(val){
        this.$emit('update:currentRow',val)
      },
      "$store.state.system.screenHeight":function(val){
        this.resetTableHeight()
      },
      "tableConfig.pageHeader.functionList": function(val){
        this.formatFunctionList()
      }
    }
}
</script>

<style lang="less" scoped>
</style>

